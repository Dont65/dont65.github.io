<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Управление правилами</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: 255, 78, 132;
            --danger-color: 231, 76, 60;
            --success-color: 46, 204, 113;
            --warning-color: 241, 196, 15;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(25, 25, 35, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid rgba(var(--primary-color), 0.3);
        }
        
        /* Шапка */
        .admin-header {
            background: linear-gradient(90deg, 
                rgba(var(--primary-color), 0.2) 0%, 
                rgba(var(--primary-color), 0.1) 100%);
            padding: 25px;
            border-bottom: 1px solid rgba(var(--primary-color), 0.3);
            position: relative;
        }
        
        .admin-header h1 {
            color: rgb(var(--primary-color));
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-header h1 i {
            font-size: 1.2em;
        }
        
        .session-status {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e74c3c;
        }
        
        .status-indicator.active {
            background-color: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        
        /* Основные секции */
        .admin-sections {
            display: flex;
            min-height: 600px;
        }
        
        /* Левая панель - авторизация */
        .auth-panel {
            width: 350px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .auth-panel.hidden {
            display: none;
        }
        
        .auth-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(var(--primary-color), 0.2);
        }
        
        .auth-section h3 {
            color: rgb(var(--primary-color));
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Правая панель - редактор */
        .editor-panel {
            flex: 1;
            padding: 30px;
            display: none;
        }
        
        .editor-panel.active {
            display: block;
        }
        
        .repo-info {
            background: rgba(var(--primary-color), 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid rgba(var(--primary-color), 0.3);
        }
        
        .repo-info h3 {
            color: rgb(var(--primary-color));
            margin-bottom: 10px;
        }
        
        /* Формы */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: rgb(var(--primary-color));
            box-shadow: 0 0 10px rgba(var(--primary-color), 0.3);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        /* Кнопки */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, 
                rgb(var(--primary-color)) 0%, 
                rgba(var(--primary-color), 0.8) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(var(--primary-color), 0.4);
        }
        
        .btn-danger {
            background: rgba(var(--danger-color), 0.9);
            color: white;
        }
        
        .btn-danger:hover {
            background: rgba(var(--danger-color), 1);
        }
        
        .btn-success {
            background: rgba(var(--success-color), 0.9);
            color: white;
        }
        
        .btn-warning {
            background: rgba(var(--warning-color), 0.9);
            color: white;
        }
        
        .btn-block {
            width: 100%;
            margin-top: 10px;
        }
        
        /* Редактор блоков */
        .blocks-container {
            margin-top: 30px;
        }
        
        .block-editor {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(var(--primary-color), 0.3);
        }
        
        .block-title {
            flex: 1;
            background: transparent;
            border: none;
            color: rgb(var(--primary-color));
            font-size: 1.4em;
            font-weight: bold;
            padding: 5px;
        }
        
        .block-title:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        
        .block-actions {
            display: flex;
            gap: 10px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .icon-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .delete-btn:hover {
            color: rgb(var(--danger-color));
        }
        
        /* Пункты правил */
        .items-container {
            margin-top: 15px;
        }
        
        .item-editor {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .item-id {
            background: rgba(var(--primary-color), 0.2);
            color: rgb(var(--primary-color));
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .item-text {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: white;
            padding: 10px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            min-height: 60px;
        }
        
        .item-text:focus {
            outline: none;
            border-color: rgba(var(--primary-color), 0.5);
        }
        
        /* Подпункты */
        .subitems-container {
            margin-top: 10px;
            margin-left: 20px;
            border-left: 2px solid rgba(var(--primary-color), 0.3);
            padding-left: 15px;
        }
        
        .subitem-editor {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .subitem-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: white;
            padding: 8px;
            font-size: 0.95em;
        }
        
        .subitem-input:focus {
            outline: none;
            border-color: rgba(var(--warning-color), 0.5);
        }
        
        /* Информационные сообщения */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .message.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .message.success {
            background: rgba(var(--success-color), 0.1);
            border: 1px solid rgba(var(--success-color), 0.3);
            color: rgb(var(--success-color));
        }
        
        .message.error {
            background: rgba(var(--danger-color), 0.1);
            border: 1px solid rgba(var(--danger-color), 0.3);
            color: rgb(var(--danger-color));
        }
        
        .message.info {
            background: rgba(var(--primary-color), 0.1);
            border: 1px solid rgba(var(--primary-color), 0.3);
            color: rgb(var(--primary-color));
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Утилиты */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none; }
        
        /* Адаптивность */
        @media (max-width: 900px) {
            .admin-sections {
                flex-direction: column;
            }
            
            .auth-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .session-status {
                position: static;
                margin-top: 15px;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка админки -->
        <div class="admin-header">
            <h1><i class="fas fa-shield-alt"></i> Админ-панель</h1>
            <p>Управление репозиторием (json only)</p>
            
            <div class="session-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="sessionStatusText">Не авторизован</span>
            </div>
        </div>
        
        <div class="admin-sections">
            <!-- Левая панель - авторизация -->
            <div class="auth-panel" id="authPanel">
                <div class="auth-section">
                    <h3><i class="fas fa-key"></i> Авторизация</h3>
                    
                    <div class="form-group">
                        <label for="repoOwner">Владелец репозитория</label>
                        <input type="text" id="repoOwner" 
                               placeholder="User"
                               autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="repoName">Название репозитория</label>
                        <input type="text" id="repoName" 
                               placeholder="repository"
                               autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" 
                               placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                               autocomplete="off">
                        <small style="color: #777; display: block; margin-top: 5px;">
                            Токен должен иметь права: <strong>repo</strong>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="repoPath">Путь к файлу json</label>
                        <input type="text" id="repoPath" 
                               value="/chat-rules/rules.json"
                               style="background: rgba(255, 255, 255, 0.07);"
                               placeholder="/your_repo/file.json"
                               autocomplete="on">
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Подключиться к репозиторию
                    </button>
                    
                    <div class="message info mt-20">
                        <p><strong>Инструкция:</strong></p>
                        <p>1. Создайте Personal Access Token на GitHub с правами <code>repo</code></p>
                        <p>2. Укажите данные своего репозитория</p>
                        <p>3. Файл правил должен находиться по пути: <code>chat-rules/rules.json</code></p>
                        <p>4. После закрытия вкладки данные очистятся</p>
                    </div>
                </div>
            </div>
            
            <!-- Правая панель - редактор -->
            <div class="editor-panel" id="editorPanel">
                <!-- Информация о репозитории -->
                <div class="repo-info">
                    <h3><i class="fas fa-database"></i> Текущий репозиторий</h3>
                    <p id="currentRepoInfo">Не подключен</p>
                    <p><small>Путь к файлу: <strong>chat-rules/rules.json</strong></small></p>
                </div>
                
                <!-- Кнопки управления -->
                <div class="text-center mb-20">
                    <button class="btn btn-success" id="saveBtn">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                    <button class="btn btn-warning" id="reloadBtn">
                        <i class="fas fa-sync-alt"></i> Обновить из репозитория
                    </button>
                    <button class="btn btn-danger" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </button>
                </div>
                
                <!-- Сообщения -->
                <div class="message success" id="successMessage">
                    <i class="fas fa-check-circle"></i> Изменения успешно сохранены!
                </div>
                
                <div class="message error" id="errorMessage">
                    <i class="fas fa-exclamation-circle"></i> Произошла ошибка
                </div>
                
                <!-- Редактор блоков -->
                <div class="blocks-container" id="blocksContainer">
                    <h3><i class="fas fa-edit"></i> Редактирование правил</h3>
                    <p class="mb-20">Добавляйте, редактируйте и удаляйте блоки правил</p>
                    
                    <button class="btn btn-primary" id="addBlockBtn">
                        <i class="fas fa-plus"></i> Добавить новый блок
                    </button>
                    
                    <!-- Здесь будут динамически добавляться блоки -->
                    <div id="blocksList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Жестко заданный путь к файлу правил
        const RULES_FILE_PATH = 'chat-rules/rules.json';
        
        // Основные переменные
        let currentRules = null;
        let currentRepoInfo = null;
        
        // Элементы DOM
        const authPanel = document.getElementById('authPanel');
        const editorPanel = document.getElementById('editorPanel');
        const statusIndicator = document.getElementById('statusIndicator');
        const sessionStatusText = document.getElementById('sessionStatusText');
        const currentRepoInfoElement = document.getElementById('currentRepoInfo');
        const blocksList = document.getElementById('blocksList');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // Кнопки
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const saveBtn = document.getElementById('saveBtn');
        const reloadBtn = document.getElementById('reloadBtn');
        const addBlockBtn = document.getElementById('addBlockBtn');
        
        // Проверяем, есть ли активная сессия при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
        });
        
        // Проверка активной сессии
        function checkSession() {
            const token = sessionStorage.getItem('github_token');
            const repoOwner = sessionStorage.getItem('repo_owner');
            const repoName = sessionStorage.getItem('repo_name');
            
            if (token && repoOwner && repoName) {
                // Есть активная сессия
                currentRepoInfo = { 
                    token, 
                    repoOwner, 
                    repoName, 
                    filePath: RULES_FILE_PATH 
                };
                updateUIForAuthenticated();
                loadRulesFromRepo();
            } else {
                // Нет активной сессии
                updateUIForUnauthenticated();
            }
        }
        
        // Обновление UI для авторизованного пользователя
        function updateUIForAuthenticated() {
            statusIndicator.classList.add('active');
            sessionStatusText.textContent = 'Авторизован';
            authPanel.classList.add('hidden');
            editorPanel.classList.add('active');
            
            currentRepoInfoElement.textContent = 
                `${currentRepoInfo.repoOwner} / ${currentRepoInfo.repoName}`;
        }
        
        // Обновление UI для неавторизованного пользователя
        function updateUIForUnauthenticated() {
            statusIndicator.classList.remove('active');
            sessionStatusText.textContent = 'Не авторизован';
            authPanel.classList.remove('hidden');
            editorPanel.classList.remove('active');
            
            // Очищаем поля авторизации
            document.getElementById('repoOwner').value = '';
            document.getElementById('repoName').value = '';
            document.getElementById('githubToken').value = '';
        }
        
        // Авторизация
        loginBtn.addEventListener('click', async () => {
            const repoOwner = document.getElementById('repoOwner').value.trim();
            const repoName = document.getElementById('repoName').value.trim();
            const token = document.getElementById('githubToken').value.trim();
            
            if (!repoOwner || !repoName || !token) {
                showMessage('error', 'Заполните все поля');
                return;
            }
            
            showMessage('info', 'Проверяем подключение...');
            
            try {
                // Проверяем, что токен и репозиторий действительны
                const isValid = await verifyGitHubAccess(token, repoOwner, repoName);
                
                if (isValid) {
                    // Сохраняем в sessionStorage (очистится при закрытии вкладки)
                    sessionStorage.setItem('github_token', token);
                    sessionStorage.setItem('repo_owner', repoOwner);
                    sessionStorage.setItem('repo_name', repoName);
                    
                    currentRepoInfo = { 
                        token, 
                        repoOwner, 
                        repoName, 
                        filePath: RULES_FILE_PATH 
                    };
                    updateUIForAuthenticated();
                    loadRulesFromRepo();
                    showMessage('success', 'Успешное подключение!');
                } else {
                    showMessage('error', 'Не удалось подключиться к репозиторию. Проверьте данные.');
                }
            } catch (error) {
                console.error('Ошибка подключения:', error);
                showMessage('error', 'Ошибка подключения: ' + error.message);
            }
        });
        
        // Выход из системы
        logoutBtn.addEventListener('click', () => {
            // Очищаем sessionStorage
            sessionStorage.clear();
            currentRepoInfo = null;
            currentRules = null;
            
            updateUIForUnauthenticated();
            showMessage('info', 'Вы вышли из системы');
        });
        
        // Проверка доступа к GitHub
        async function verifyGitHubAccess(token, owner, repo) {
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        // Загрузка правил из репозитория
        async function loadRulesFromRepo() {
            if (!currentRepoInfo) return;
            
            showMessage('info', 'Загружаем правила...');
            
            try {
                const { token, repoOwner, repoName } = currentRepoInfo;
                // Используем жестко заданный путь
                const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${RULES_FILE_PATH}`;
                
                console.log('Загружаем из:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    // Если файла нет, создаем пустую структуру
                    if (response.status === 404) {
                        currentRules = {
                            lastUpdate: new Date().toLocaleDateString('ru-RU'),
                            blocks: []
                        };
                        renderBlocks();
                        showMessage('info', 'Файл правил не найден. Создан новый.');
                        return;
                    }
                    throw new Error('Ошибка загрузки файла: ' + response.status);
                }
                
                const data = await response.json();
                
                // ПРАВИЛЬНОЕ ДЕКОДИРОВАНИЕ ИЗ BASE64 (для UTF-8)
                const binaryString = atob(data.content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decoder = new TextDecoder('utf-8');
                const jsonString = decoder.decode(bytes);
                console.log('Получен JSON'); // для отладки

                if (!jsonString.trim()) {
                    // Если файл пустой, создаем новую структуру
                    currentRules = {
                        lastUpdate: new Date().toLocaleDateString('ru-RU'),
                        blocks: []
                    };
                } else {
                    currentRules = JSON.parse(jsonString);
                }
                
                currentRules = JSON.parse(jsonString);
                renderBlocks();
                showMessage('success', 'Правила успешно загружены');
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                showMessage('error', 'Ошибка загрузки: ' + error.message);
            }
        }
        
        // Сохранение правил в репозиторий
        async function saveRulesToRepo() {
            if (!currentRepoInfo || !currentRules) return;
            
            showMessage('info', 'Сохраняем изменения...');
            
            try {
                const { token, repoOwner, repoName } = currentRepoInfo;
                
                // Получаем текущий SHA файла (используем жесткий путь)
                const getUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${RULES_FILE_PATH}`;
                const getResponse = await fetch(getUrl, {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // Обновляем дату последнего изменения
                currentRules.lastUpdate = new Date().toLocaleDateString('ru-RU');
                
                // ПРАВИЛЬНОЕ КОДИРОВАНИЕ В BASE64 (для UTF-8)
                const jsonString = JSON.stringify(currentRules, null, 2);
                const encoder = new TextEncoder();
                const data = encoder.encode(jsonString);
                let binary = '';
                data.forEach(byte => binary += String.fromCharCode(byte));
                const content = btoa(binary);
                
                // Отправляем на GitHub (используем жесткий путь)
                const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${RULES_FILE_PATH}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Обновление правил через админ-панель',
                        content: content,
                        sha: sha
                    })
                });
                
                if (response.ok) {
                    showMessage('success', 'Правила успешно сохранены в репозиторий!');
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Ошибка сохранения');
                }
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                showMessage('error', 'Ошибка сохранения: ' + error.message);
            }
        }
        
        // Отображение блоков правил
        function renderBlocks() {
            if (!currentRules || !currentRules.blocks) {
                blocksList.innerHTML = '<div class="message info">Нет правил для отображения</div>';
                return;
            }
            
            blocksList.innerHTML = '';
            
            currentRules.blocks.forEach((block, blockIndex) => {
                const blockElement = document.createElement('div');
                blockElement.className = 'block-editor';
                blockElement.innerHTML = `
                    <div class="block-header">
                        <input type="text" class="block-title" 
                               value="${escapeHtml(block.title)}" 
                               data-block-index="${blockIndex}"
                               placeholder="Название блока">
                        <div class="block-actions">
                            <button class="icon-btn move-up-btn" title="Переместить вверх" data-block-index="${blockIndex}">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="icon-btn move-down-btn" title="Переместить вниз" data-block-index="${blockIndex}">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="icon-btn delete-btn" title="Удалить блок" data-block-index="${blockIndex}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="items-container" id="items-${blockIndex}">
                        ${renderItems(block.items, blockIndex)}
                    </div>
                    
                    <button class="btn btn-primary add-item-btn" data-block-index="${blockIndex}">
                        <i class="fas fa-plus"></i> Добавить пункт
                    </button>
                `;
                
                blocksList.appendChild(blockElement);
            });
            
            // Назначаем обработчики событий
            attachBlockEventListeners();
        }
        
        // Отображение пунктов правил
        function renderItems(items, blockIndex) {
            if (!items || items.length === 0) {
                return '<div class="message info">Пока нет пунктов правил</div>';
            }
            
            return items.map((item, itemIndex) => `
                <div class="item-editor" data-item-index="${itemIndex}">
                    <div class="item-header">
                        <span class="item-id">${item.id || `Пункт ${itemIndex + 1}`}</span>
                        <div class="block-actions">
                            <button class="icon-btn delete-item-btn" 
                                    data-block-index="${blockIndex}" 
                                    data-item-index="${itemIndex}"
                                    title="Удалить пункт">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <textarea class="item-text" 
                              data-block-index="${blockIndex}" 
                              data-item-index="${itemIndex}"
                              placeholder="Текст пункта правил">${escapeHtml(item.text)}</textarea>
                    
                    <div class="subitems-container" id="subitems-${blockIndex}-${itemIndex}">
                        <h4>Подпункты:</h4>
                        ${renderSubitems(item.subitems, blockIndex, itemIndex)}
                    </div>
                    
                    <button class="btn btn-primary add-subitem-btn" 
                            data-block-index="${blockIndex}" 
                            data-item-index="${itemIndex}">
                        <i class="fas fa-plus"></i> Добавить подпункт
                    </button>
                </div>
            `).join('');
        }
        
        // Отображение подпунктов
        function renderSubitems(subitems, blockIndex, itemIndex) {
            if (!subitems || subitems.length === 0) {
                return '<div class="message info">Пока нет подпунктов</div>';
            }
            
            return subitems.map((subitem, subitemIndex) => `
                <div class="subitem-editor">
                    <input type="text" class="subitem-input" 
                           value="${escapeHtml(subitem)}"
                           data-block-index="${blockIndex}"
                           data-item-index="${itemIndex}"
                           data-subitem-index="${subitemIndex}"
                           placeholder="Текст подпункта">
                    <button class="icon-btn delete-subitem-btn"
                            data-block-index="${blockIndex}"
                            data-item-index="${itemIndex}"
                            data-subitem-index="${subitemIndex}"
                            title="Удалить подпункт">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Прикрепление обработчиков событий к элементам блоков
        function attachBlockEventListeners() {
            // Обновление заголовка блока
            document.querySelectorAll('.block-title').forEach(input => {
                input.addEventListener('input', (e) => {
                    const blockIndex = parseInt(e.target.dataset.blockIndex);
                    currentRules.blocks[blockIndex].title = e.target.value;
                });
            });
            
            // Удаление блока
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.blockIndex);
                    if (confirm('Удалить этот блок правил?')) {
                        currentRules.blocks.splice(blockIndex, 1);
                        renderBlocks();
                    }
                });
            });
            
            // Добавление нового пункта
            document.querySelectorAll('.add-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.blockIndex);
                    if (!currentRules.blocks[blockIndex].items) {
                        currentRules.blocks[blockIndex].items = [];
                    }
                    
                    const newItem = {
                        id: generateItemId(blockIndex),
                        text: 'Новый пункт правил...',
                        subitems: []
                    };
                    
                    currentRules.blocks[blockIndex].items.push(newItem);
                    renderBlocks();
                });
            });
            
            // Удаление пункта
            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.blockIndex);
                    const itemIndex = parseInt(e.target.closest('button').dataset.itemIndex);
                    
                    if (confirm('Удалить этот пункт правил?')) {
                        currentRules.blocks[blockIndex].items.splice(itemIndex, 1);
                        renderBlocks();
                    }
                });
            });
            
            // Обновление текста пункта
            document.querySelectorAll('.item-text').forEach(textarea => {
                textarea.addEventListener('input', (e) => {
                    const blockIndex = parseInt(e.target.dataset.blockIndex);
                    const itemIndex = parseInt(e.target.dataset.itemIndex);
                    currentRules.blocks[blockIndex].items[itemIndex].text = e.target.value;
                });
            });
            
            // Добавление подпункта
            document.querySelectorAll('.add-subitem-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.blockIndex);
                    const itemIndex = parseInt(e.target.closest('button').dataset.itemIndex);
                    
                    if (!currentRules.blocks[blockIndex].items[itemIndex].subitems) {
                        currentRules.blocks[blockIndex].items[itemIndex].subitems = [];
                    }
                    
                    currentRules.blocks[blockIndex].items[itemIndex].subitems.push('Новый подпункт...');
                    renderBlocks();
                });
            });
            
            // Обновление подпункта
            document.querySelectorAll('.subitem-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const blockIndex = parseInt(e.target.dataset.blockIndex);
                    const itemIndex = parseInt(e.target.dataset.itemIndex);
                    const subitemIndex = parseInt(e.target.dataset.subitemIndex);
                    currentRules.blocks[blockIndex].items[itemIndex].subitems[subitemIndex] = e.target.value;
                });
            });
            
            // Удаление подпункта
            document.querySelectorAll('.delete-subitem-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.blockIndex);
                    const itemIndex = parseInt(e.target.closest('button').dataset.itemIndex);
                    const subitemIndex = parseInt(e.target.closest('button').dataset.subitemIndex);
                    
                    currentRules.blocks[blockIndex].items[itemIndex].subitems.splice(subitemIndex, 1);
                    renderBlocks();
                });
            });
            
            // Перемещение блоков вверх/вниз
            document.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.blockIndex);
                    if (blockIndex > 0) {
                        [currentRules.blocks[blockIndex], currentRules.blocks[blockIndex - 1]] = 
                        [currentRules.blocks[blockIndex - 1], currentRules.blocks[blockIndex]];
                        renderBlocks();
                    }
                });
            });
            
            document.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.blockIndex);
                    if (blockIndex < currentRules.blocks.length - 1) {
                        [currentRules.blocks[blockIndex], currentRules.blocks[blockIndex + 1]] = 
                        [currentRules.blocks[blockIndex + 1], currentRules.blocks[blockIndex]];
                        renderBlocks();
                    }
                });
            });
        }
        
        // Добавление нового блока
        addBlockBtn.addEventListener('click', () => {
            if (!currentRules.blocks) {
                currentRules.blocks = [];
            }
            
            const newBlock = {
                id: `block-${Date.now()}`,
                title: 'Новый блок правил',
                icon: 'fas fa-edit',
                items: []
            };
            
            currentRules.blocks.push(newBlock);
            renderBlocks();
        });
        
        // Сохранение правил
        saveBtn.addEventListener('click', () => {
            saveRulesToRepo();
        });
        
        // Обновление правил из репозитория
        reloadBtn.addEventListener('click', () => {
            loadRulesFromRepo();
        });
        
        // Вспомогательные функции
        function showMessage(type, text) {
            const message = type === 'success' ? successMessage : 
                           type === 'error' ? errorMessage : null;
            
            if (message) {
                message.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${text}`;
                message.className = `message ${type} show`;
                
                setTimeout(() => {
                    message.classList.remove('show');
                }, 5000);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function generateItemId(blockIndex) {
            const blockNumber = blockIndex + 1;
            const itemCount = currentRules.blocks[blockIndex].items ? 
                             currentRules.blocks[blockIndex].items.length + 1 : 1;
            return `${blockNumber}.${itemCount}`;
        }
    </script>
</body>
</html>
