<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Админ-панель • Управление правилами</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --md-primary: #D32F2F; /* Красный акцентный цвет */
            --md-primary-container: #FFCDD2;
            --md-secondary: #625B71;
            --md-secondary-container: #E8DEF8;
            --md-surface: #141218;
            --md-surface-container: #1D1B20;
            --md-surface-container-high: #2D2A32;
            --md-on-primary: #FFFFFF;
            --md-on-surface: #E6E0E9;
            --md-on-surface-variant: #CAC4D0;
            --md-outline: #938F99;
            --md-outline-variant: #49454F;
            --md-error: #F2B8B5;
            --md-error-container: #8C1D18;
            --md-success: #4CAF50;
            --md-warning: #FF9800;
            --md-elevation-1: 0 1px 2px rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
            --md-elevation-2: 0 1px 2px rgba(0,0,0,0.3), 0 2px 6px 2px rgba(0,0,0,0.15);
            --md-elevation-3: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3);
            --md-radius-small: 8px;
            --md-radius-medium: 12px;
            --md-radius-large: 16px;
            --md-transition: 200ms cubic-bezier(0.2, 0, 0, 1);
            
            /* Для мобильной навигации */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--md-surface);
            color: var(--md-on-surface);
            line-height: 1.5;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }
        
        /* Полноэкранный контейнер */
        .fullscreen-container {
            height: 100vh;
            height: -webkit-fill-available;
            height: calc(100vh - var(--safe-area-top) - var(--safe-area-bottom));
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Шапка - фиксированная */
        .admin-header {
            flex-shrink: 0;
            padding: 16px 20px;
            background: var(--md-surface-container);
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            align-items: center;
            justify-content: center; /* Центрируем заголовок на ПК */
            position: relative;
            z-index: 10;
        }
        
        /* Компактная шапка для мобильных */
        .mobile-header {
            display: none;
            padding: 12px 16px;
            background: var(--md-surface-container);
            border-bottom: 1px solid var(--md-outline-variant);
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 10;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
            justify-content: center; /* Центрируем содержимое */
        }
        
        .header-icon {
            width: 36px;
            height: 36px;
            background: var(--md-primary);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-on-primary);
            flex-shrink: 0;
        }
        
        .header-title {
            min-width: 0;
            text-align: center; /* Центрируем текст */
        }
        
        .header-title h1 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-title p {
            color: var(--md-on-surface-variant);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .session-status {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--md-surface-container-high);
            border-radius: var(--md-radius-medium);
            flex-shrink: 0;
        }
        
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--md-outline);
        }
        
        .status-indicator.active {
            background: var(--md-success);
            box-shadow: 0 0 6px var(--md-success);
        }
        
        /* Основное содержимое - занимает все оставшееся пространство */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        /* Десктопный макет - центрированный */
        .desktop-layout {
            display: grid;
            grid-template-columns: 1fr minmax(500px, 600px) 1fr; /* Центральная колонка фиксированной ширины */
            width: 100%;
            height: 100%;
        }
        
        /* Контейнер для центрирования контента на ПК */
        .pc-centered-content {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }
        
        /* Мобильный макет - через переключатель экранов */
        .mobile-layout {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .mobile-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--md-surface-container);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: transform 0.3s ease;
            padding: 16px;
        }
        
        .mobile-screen.hidden {
            transform: translateX(100%);
        }
        
        /* Панель авторизации для ПК - центрированная */
        .auth-card {
            background: var(--md-surface-container);
            border-radius: var(--md-radius-large);
            padding: 40px; /* Увеличиваем отступы */
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }
        
        .auth-card.hidden {
            display: none;
        }
        
        /* Панель редактора для ПК */
        .editor-panel {
            background: var(--md-surface-container);
            border-radius: var(--md-radius-large);
            padding: 40px; /* Увеличиваем отступы */
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }
        
        .editor-panel.hidden {
            display: none;
        }
        
        .editor-panel.active {
            display: flex;
        }
        
        .editor-header {
            flex-shrink: 0;
            margin-bottom: 20px;
        }
        
        .editor-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Информация о репозитории */
        .repo-info {
            background: var(--md-surface-container-high);
            border-radius: var(--md-radius-medium);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        /* Формы - улучшены для мобильных */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .text-field {
            position: relative;
        }
        
        .text-field input,
        .text-field textarea {
            width: 100%;
            padding: 14px 16px;
            background: transparent;
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-radius-small);
            color: var(--md-on-surface);
            font-size: 16px;
            font-family: inherit;
            transition: var(--md-transition);
            -webkit-appearance: none;
        }
        
        .text-field input:focus,
        .text-field textarea:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.3); /* Красная тень */
        }
        
        .text-field textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Кнопки - увеличены для мобильных */
        .button {
            padding: 16px 24px;
            border: none;
            border-radius: var(--md-radius-medium);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--md-transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 48px;
        }
        
        .button--filled {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }
        
        .button--filled:hover {
            background: #B71C1C; /* Темнее красный */
            box-shadow: var(--md-elevation-1);
        }
        
        .button--tonal {
            background: var(--md-primary-container);
            color: var(--md-primary);
        }
        
        .button--outlined {
            background: transparent;
            color: var(--md-primary);
            border: 1px solid var(--md-outline);
        }
        
        .button--danger {
            background: var(--md-error-container);
            color: white;
        }
        
        .button--success {
            background: var(--md-success);
            color: white;
        }
        
        .button--full-width {
            width: 100%;
        }
        
        .button--icon {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 24px;
            min-height: auto;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        /* Редактор блоков */
        .blocks-container {
            margin-top: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
            text-align: center; /* Центрируем заголовки на ПК */
        }
        
        .blocks-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }
        
        .block-card {
            background: var(--md-surface-container-high);
            border-radius: var(--md-radius-medium);
            padding: 16px;
            border-left: 4px solid var(--md-primary);
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .block-title-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            font-size: 16px;
            font-weight: 500;
            padding: 8px 0;
            border-bottom: 1px solid transparent;
            min-width: 0;
        }
        
        .block-title-input:focus {
            outline: none;
            border-bottom-color: var(--md-primary);
        }
        
        .block-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        /* Пункты правил */
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }
        
        .item-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--md-radius-small);
            padding: 12px;
            border: 1px solid var(--md-outline-variant);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .item-id {
            color: var(--md-primary);
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            background: rgba(211, 47, 47, 0.1); /* Красный с прозрачностью */
            border-radius: 4px;
        }
        
        .item-text {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--md-on-surface);
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            padding: 8px;
        }
        
        .item-text:focus {
            outline: none;
        }
        
        /* Подпункты */
        .subitems-container {
            margin-top: 8px;
            padding-left: 12px;
            border-left: 2px solid var(--md-outline-variant);
        }
        
        .subitem-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .subitem-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--md-on-surface-variant);
            padding: 6px 0;
            font-size: 13px;
            min-width: 0;
        }
        
        .subitem-input:focus {
            outline: none;
            color: var(--md-on-surface);
        }
        
        /* Иконки кнопок */
        .icon-button {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--md-on-surface-variant);
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--md-transition);
            flex-shrink: 0;
        }
        
        .icon-button:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--md-on-surface);
        }
        
        .icon-button--danger:hover {
            color: var(--md-primary); /* Красный вместо стандартного error */
        }
        
        /* Мобильная навигация */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: max(16px, var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: var(--md-surface-container-high);
            border-radius: 24px;
            padding: 8px;
            box-shadow: var(--md-elevation-3);
            z-index: 100;
            gap: 4px;
        }
        
        .nav-button {
            width: 56px;
            height: 56px;
            border: none;
            background: transparent;
            color: var(--md-on-surface-variant);
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: var(--md-transition);
            font-size: 11px;
        }
        
        .nav-button.active {
            background: var(--md-primary); /* Красный акцент */
            color: var(--md-on-primary);
        }
        
        /* Snackbar для уведомлений */
        .snackbar {
            position: fixed;
            bottom: max(80px, calc(80px + var(--safe-area-bottom)));
            left: 16px;
            right: 16px;
            background: var(--md-surface-container-high);
            color: var(--md-on-surface);
            padding: 12px 16px;
            border-radius: var(--md-radius-medium);
            box-shadow: var(--md-elevation-3);
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 300ms cubic-bezier(0.2, 0, 0, 1);
            z-index: 1000;
            pointer-events: none;
        }
        
        .snackbar.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .snackbar--success {
            border-left: 4px solid var(--md-success);
        }
        
        .snackbar--error {
            border-left: 4px solid var(--md-primary); /* Красный акцент */
        }
        
        .snackbar--info {
            border-left: 4px solid var(--md-primary); /* Красный акцент */
        }
        
        /* Утилиты */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--md-surface-container-high);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .divider {
            height: 1px;
            background: var(--md-outline-variant);
            margin: 16px 0;
        }
        
        .text-caption {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            margin-top: 4px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--md-on-surface-variant);
        }
        
        .empty-state i {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            /* Скрываем десктопный макет, показываем мобильный */
            .desktop-layout {
                display: none;
            }
            
            .mobile-layout {
                display: block;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .admin-header {
                display: none;
            }
            
            .mobile-nav {
                display: flex;
            }
            
            /* Адаптивные кнопки */
            .button-group {
                flex-direction: column;
            }
            
            .button {
                padding: 18px 24px;
                font-size: 16px;
            }
            
            /* Адаптивные текстовые поля */
            .text-field input,
            .text-field textarea {
                padding: 18px 16px;
                font-size: 16px;
            }
            
            /* Улучшаем скролл на iOS */
            .mobile-screen {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            /* Убираем лишние отступы на маленьких экранах */
            .auth-card,
            .editor-panel {
                padding: 16px;
                border-radius: 0;
            }
            
            /* Компактные блоки на маленьких экранах */
            .block-card {
                padding: 12px;
            }
            
            .block-title-input {
                font-size: 15px;
            }
            
            .item-card {
                padding: 10px;
            }
        }
        
        /* Для очень маленьких экранов */
        @media (max-width: 360px) {
            .mobile-screen {
                padding: 12px;
            }
            
            .button {
                padding: 16px 20px;
                font-size: 14px;
            }
            
            .text-field input,
            .text-field textarea {
                padding: 16px 12px;
                font-size: 15px;
            }
            
            .nav-button {
                width: 52px;
                height: 52px;
                font-size: 10px;
            }
            
            .snackbar {
                left: 12px;
                right: 12px;
            }
        }
        
        /* Ландшафтная ориентация на мобильных */
        @media (max-width: 900px) and (orientation: landscape) {
            .fullscreen-container {
                height: auto;
                min-height: 100vh;
            }
            
            .mobile-header {
                padding: 8px 12px;
            }
            
            .header-icon {
                width: 32px;
                height: 32px;
            }
            
            .mobile-screen {
                padding: 12px;
            }
            
            .auth-card,
            .editor-panel {
                padding: 12px;
            }
            
            .button {
                padding: 12px 16px;
                min-height: 40px;
            }
            
            .text-field input,
            .text-field textarea {
                padding: 12px;
            }
        }
        
        /* Десктопные улучшения */
        @media (min-width: 769px) {
            .auth-card {
                box-shadow: none;
            }
            
            .editor-panel {
                margin-left: 0;
            }
            
            .main-content {
                padding: 0;
            }
            
            /* Центрируем заголовок формы на ПК */
            .card-title {
                text-align: center;
                margin-bottom: 32px;
                font-size: 20px;
            }
            
            /* Центрируем кнопки на ПК */
            .button--full-width {
                margin: 0 auto;
                max-width: 400px;
            }
            
            /* Центрируем текстовые инструкции на ПК */
            .text-caption {
                text-align: center;
                margin: 16px auto;
                max-width: 500px;
            }
            
            /* Путь файла - делаем более заметным */
            .file-path-container {
                background: var(--md-surface-container-high);
                border-radius: var(--md-radius-medium);
                padding: 16px;
                margin: 20px 0;
                text-align: center;
            }
            
            .file-path-input {
                font-family: monospace;
                background: var(--md-surface);
                border: 1px solid var(--md-outline);
                color: var(--md-primary);
                font-weight: bold;
            }
        }
        
        /* Анимации */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="fullscreen-container">
        <!-- Десктопная шапка -->
        <div class="admin-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="header-title">
                    <h1>Управление правилами</h1>
                    <p>Редактирование JSON репозитория</p>
                </div>
            </div>
            
            <div class="session-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="sessionStatusText">Не подключено</span>
            </div>
        </div>
        
        <!-- Мобильная шапка -->
        <div class="mobile-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="header-title">
                    <h1>Правила чата</h1>
                    <p id="mobileRepoInfo">Гость</p>
                </div>
            </div>
            
            <div class="session-status">
                <div class="status-indicator" id="mobileStatusIndicator"></div>
            </div>
        </div>
        
        <!-- Основное содержимое -->
        <div class="main-content">
            <!-- Десктопный макет -->
            <div class="desktop-layout">
                <div class="pc-centered-content">
                    <!-- Панель авторизации -->
                    <div class="auth-card" id="authPanel">
                        <div class="card-title" style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 32px; font-size: 20px; font-weight: 500;">
                            <i class="fas fa-key"></i>
                            <span>Подключение к GitHub</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Владелец репозитория</label>
                            <div class="text-field">
                                <input type="text" id="repoOwner" placeholder="username" autocomplete="off">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Название репозитория</label>
                            <div class="text-field">
                                <input type="text" id="repoName" placeholder="repository-name" autocomplete="off">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Путь к файлу JSON</label>
                            <div class="text-field">
                                <input type="text" id="filePath" placeholder="chat-rules/rules.json" value="chat-rules/rules.json" autocomplete="off" class="file-path-input">
                            </div>
                            <p class="text-caption">Укажите путь к файлу в репозитории</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">GitHub Token</label>
                            <div class="text-field">
                                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
                            </div>
                            <p class="text-caption">Требуются права: <strong>repo</strong></p>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <button class="button button--filled button--full-width" id="loginBtn">
                            <i class="fas fa-link"></i>
                            <span>Подключиться</span>
                        </button>
                        
                        <div style="margin-top: 32px; text-align: center;">
                            <p class="text-caption" style="max-width: 500px; margin: 0 auto;">
                                <strong>Как это работает:</strong><br>
                                1. Создайте Personal Access Token на GitHub<br>
                                2. Укажите данные вашего репозитория<br>
                                3. Укажите путь к файлу JSON<br>
                                4. Редактируйте и сохраняйте изменения
                            </p>
                        </div>
                    </div>
                    
                    <!-- Панель редактора -->
                    <div class="editor-panel hidden" id="editorPanel">
                        <div class="editor-header">
                            <!-- Информация о подключении -->
                            <div class="repo-info" style="text-align: center;">
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 16px; font-weight: 500;">
                                        <i class="fas fa-database"></i>
                                        <span>Текущий репозиторий</span>
                                    </div>
                                    <p id="currentRepoInfo" style="font-family: monospace; font-size: 14px;">Не подключен</p>
                                    <div class="file-path-container">
                                        <label class="form-label">Путь к файлу</label>
                                        <div class="text-field">
                                            <input type="text" id="currentFilePath" placeholder="chat-rules/rules.json" autocomplete="off" class="file-path-input">
                                        </div>
                                        <p class="text-caption" style="margin-top: 8px;">Измените путь и нажмите Сохранить</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Управление -->
                            <div class="button-group" style="justify-content: center;">
                                <button class="button button--tonal" id="saveBtn">
                                    <i class="fas fa-save"></i>
                                    Сохранить
                                </button>
                                <button class="button button--outlined" id="reloadBtn">
                                    <i class="fas fa-sync-alt"></i>
                                    Обновить
                                </button>
                                <button class="button button--danger" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Выйти
                                </button>
                            </div>
                        </div>
                        
                        <div class="editor-content">
                            <!-- Редактор блоков -->
                            <div class="blocks-container">
                                <h2 class="section-title">Блоки правил</h2>
                                <p class="text-caption" style="text-align: center;">Редактируйте структуру правил чата</p>
                                
                                <div class="blocks-list" id="blocksList">
                                    <!-- Блоки будут добавляться сюда -->
                                </div>
                                
                                <div style="display: flex; justify-content: center; margin-top: 20px;">
                                    <button class="button button--filled" id="addBlockBtn" style="min-width: 200px;">
                                        <i class="fas fa-plus"></i>
                                        Добавить блок
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Мобильный макет -->
            <div class="mobile-layout">
                <!-- Экран авторизации -->
                <div class="mobile-screen" id="mobileAuthScreen">
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; font-size: 18px; font-weight: 500;">
                            <i class="fas fa-key"></i>
                            <span>Подключение к GitHub</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Владелец репозитория</label>
                            <div class="text-field">
                                <input type="text" id="mobileRepoOwner" placeholder="username" autocomplete="off">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Название репозитория</label>
                            <div class="text-field">
                                <input type="text" id="mobileRepoName" placeholder="repository-name" autocomplete="off">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">GitHub Token</label>
                            <div class="text-field">
                                <input type="password" id="mobileGithubToken" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
                            </div>
                            <p class="text-caption">Требуются права: <strong>repo</strong></p>
                        </div>
                        
                        <button class="button button--filled button--full-width" id="mobileLoginBtn" style="margin-top: 24px;">
                            <i class="fas fa-link"></i>
                            <span>Подключиться</span>
                        </button>
                        
                        <div style="margin-top: 32px; padding: 16px; background: var(--md-surface-container-high); border-radius: var(--md-radius-medium);">
                            <p class="text-caption" style="text-align: left;">
                                <strong>Инструкция:</strong><br>
                                1. Создайте Personal Access Token на GitHub<br>
                                2. Укажите данные вашего репозитория<br>
                                3. Файл будет сохранён по пути: <code>chat-rules/rules.json</code>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Экран редактора -->
                <div class="mobile-screen hidden" id="mobileEditorScreen">
                    <div class="editor-content">
                        <!-- Информация о подключении -->
                        <div class="repo-info" style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 14px; font-weight: 500;">
                                        <i class="fas fa-database"></i>
                                        <span>Репозиторий</span>
                                    </div>
                                    <p id="mobileCurrentRepoInfo" style="font-family: monospace; font-size: 13px;">Не подключен</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Управление -->
                        <div class="button-group">
                            <button class="button button--tonal" id="mobileSaveBtn" style="flex: 1;">
                                <i class="fas fa-save"></i>
                                Сохранить
                            </button>
                            <button class="button button--outlined" id="mobileReloadBtn" style="flex: 1;">
                                <i class="fas fa-sync-alt"></i>
                                Обновить
                            </button>
                        </div>
                        
                        <!-- Редактор блоков -->
                        <div class="blocks-container">
                            <h2 class="section-title">Блоки правил</h2>
                            
                            <div class="blocks-list" id="mobileBlocksList">
                                <!-- Блоки будут добавляться сюда -->
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button class="button button--filled" id="mobileAddBlockBtn" style="flex: 1;">
                                    <i class="fas fa-plus"></i>
                                    Добавить блок
                                </button>
                                <button class="button button--danger button--icon" id="mobileLogoutBtn">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Мобильная навигация -->
        <div class="mobile-nav">
            <button class="nav-button" id="navAuth" data-screen="auth">
                <i class="fas fa-key"></i>
                <span>Подключение</span>
            </button>
            <button class="nav-button" id="navEditor" data-screen="editor">
                <i class="fas fa-edit"></i>
                <span>Редактор</span>
            </button>
        </div>
    </div>

    <!-- Snackbar для уведомлений -->
    <div class="snackbar" id="snackbar"></div>

    <script>
        // Конфигурация
        const DEFAULT_FILE_PATH = 'chat-rules/rules.json';
        
        // Состояние приложения
        let currentRules = null;
        let currentRepoInfo = null;
        let isMobile = window.innerWidth <= 768;
        
        // Определяем тип устройства
        function checkDeviceType() {
            isMobile = window.innerWidth <= 768;
            updateLayout();
        }
        
        // Обновляем layout в зависимости от устройства
        function updateLayout() {
            if (isMobile) {
                document.querySelector('.desktop-layout').style.display = 'none';
                document.querySelector('.mobile-layout').style.display = 'block';
                document.querySelector('.mobile-header').style.display = 'flex';
                document.querySelector('.mobile-nav').style.display = 'flex';
            } else {
                document.querySelector('.desktop-layout').style.display = 'grid';
                document.querySelector('.mobile-layout').style.display = 'none';
                document.querySelector('.mobile-header').style.display = 'none';
                document.querySelector('.mobile-nav').style.display = 'none';
            }
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            checkDeviceType();
            checkSession();
            setupEventListeners();
        });
        
        // Ресайз окна
        window.addEventListener('resize', checkDeviceType);
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Десктопные элементы
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const saveBtn = document.getElementById('saveBtn');
            const reloadBtn = document.getElementById('reloadBtn');
            const addBlockBtn = document.getElementById('addBlockBtn');
            const filePathInput = document.getElementById('filePath');
            const currentFilePathInput = document.getElementById('currentFilePath');
            
            // Мобильные элементы
            const mobileLoginBtn = document.getElementById('mobileLoginBtn');
            const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
            const mobileSaveBtn = document.getElementById('mobileSaveBtn');
            const mobileReloadBtn = document.getElementById('mobileReloadBtn');
            const mobileAddBlockBtn = document.getElementById('mobileAddBlockBtn');
            
            // Кнопки навигации
            const navAuth = document.getElementById('navAuth');
            const navEditor = document.getElementById('navEditor');
            
            // Десктопные события
            if (loginBtn) loginBtn.addEventListener('click', handleLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (saveBtn) saveBtn.addEventListener('click', handleSave);
            if (reloadBtn) reloadBtn.addEventListener('click', handleReload);
            if (addBlockBtn) addBlockBtn.addEventListener('click', handleAddBlock);
            if (filePathInput) filePathInput.addEventListener('change', handleFilePathChange);
            if (currentFilePathInput) currentFilePathInput.addEventListener('change', handleCurrentFilePathChange);
            
            // Мобильные события
            if (mobileLoginBtn) mobileLoginBtn.addEventListener('click', handleLogin);
            if (mobileLogoutBtn) mobileLogoutBtn.addEventListener('click', handleLogout);
            if (mobileSaveBtn) mobileSaveBtn.addEventListener('click', handleSave);
            if (mobileReloadBtn) mobileReloadBtn.addEventListener('click', handleReload);
            if (mobileAddBlockBtn) mobileAddBlockBtn.addEventListener('click', handleAddBlock);
            
            // Навигация
            if (navAuth) navAuth.addEventListener('click', () => switchMobileScreen('auth'));
            if (navEditor) navEditor.addEventListener('click', () => switchMobileScreen('editor'));
            
            // Прямая отправка формы по Enter
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.target.id === 'githubToken' || e.target.id === 'mobileGithubToken')) {
                    handleLogin();
                }
            });
        }
        
        // Переключение мобильных экранов
        function switchMobileScreen(screen) {
            const authScreen = document.getElementById('mobileAuthScreen');
            const editorScreen = document.getElementById('mobileEditorScreen');
            const navAuth = document.getElementById('navAuth');
            const navEditor = document.getElementById('navEditor');
            
            if (screen === 'auth') {
                authScreen.classList.remove('hidden');
                editorScreen.classList.add('hidden');
                navAuth.classList.add('active');
                navEditor.classList.remove('active');
            } else {
                authScreen.classList.add('hidden');
                editorScreen.classList.remove('hidden');
                navAuth.classList.remove('active');
                navEditor.classList.add('active');
            }
        }
        
        // Проверка сессии
        function checkSession() {
            const token = sessionStorage.getItem('github_token');
            const repoOwner = sessionStorage.getItem('repo_owner');
            const repoName = sessionStorage.getItem('repo_name');
            const filePath = sessionStorage.getItem('file_path') || DEFAULT_FILE_PATH;
            
            if (token && repoOwner && repoName) {
                currentRepoInfo = { token, repoOwner, repoName, filePath };
                updateUIForAuthenticated();
                loadRulesFromRepo();
            } else {
                updateUIForUnauthenticated();
            }
        }
        
        // Обновление UI при авторизации
        function updateUIForAuthenticated() {
            // Обновляем статус
            const statusIndicators = document.querySelectorAll('.status-indicator');
            statusIndicators.forEach(indicator => indicator.classList.add('active'));
            
            const statusTexts = document.querySelectorAll('#sessionStatusText, #mobileRepoInfo');
            statusTexts.forEach(element => {
                if (element.id === 'mobileRepoInfo') {
                    element.textContent = currentRepoInfo.repoOwner;
                } else {
                    element.textContent = 'Подключено';
                }
            });
            
            // Обновляем информацию о репозитории
            const repoInfoElements = document.querySelectorAll('#currentRepoInfo, #mobileCurrentRepoInfo');
            repoInfoElements.forEach(element => {
                element.textContent = `${currentRepoInfo.repoOwner}/${currentRepoInfo.repoName}`;
            });
            
            // Обновляем путь к файлу
            const filePathInput = document.getElementById('filePath');
            const currentFilePathInput = document.getElementById('currentFilePath');
            if (filePathInput) filePathInput.value = currentRepoInfo.filePath;
            if (currentFilePathInput) currentFilePathInput.value = currentRepoInfo.filePath;
            
            // Переключаем экраны
            if (isMobile) {
                document.getElementById('authPanel').classList.add('hidden');
                document.getElementById('editorPanel').classList.add('active');
                switchMobileScreen('editor');
            } else {
                document.getElementById('authPanel').classList.add('hidden');
                document.getElementById('editorPanel').classList.remove('hidden');
                document.getElementById('editorPanel').classList.add('active');
            }
            
            // Активируем кнопку редактора в навигации
            const navEditor = document.getElementById('navEditor');
            if (navEditor) {
                navEditor.classList.add('active');
                navEditor.disabled = false;
            }
        }
        
        // Обновление UI при выходе
        function updateUIForUnauthenticated() {
            // Обновляем статус
            const statusIndicators = document.querySelectorAll('.status-indicator');
            statusIndicators.forEach(indicator => indicator.classList.remove('active'));
            
            const statusTexts = document.querySelectorAll('#sessionStatusText, #mobileRepoInfo');
            statusTexts.forEach(element => {
                if (element.id === 'mobileRepoInfo') {
                    element.textContent = 'Гость';
                } else {
                    element.textContent = 'Не подключено';
                }
            });
            
            // Очищаем информацию о репозитории
            const repoInfoElements = document.querySelectorAll('#currentRepoInfo, #mobileCurrentRepoInfo');
            repoInfoElements.forEach(element => {
                element.textContent = 'Не подключен';
            });
            
            // Сбрасываем путь к файлу
            const filePathInput = document.getElementById('filePath');
            const currentFilePathInput = document.getElementById('currentFilePath');
            if (filePathInput) filePathInput.value = DEFAULT_FILE_PATH;
            if (currentFilePathInput) currentFilePathInput.value = DEFAULT_FILE_PATH;
            
            // Переключаем экраны
            if (isMobile) {
                switchMobileScreen('auth');
            } else {
                document.getElementById('authPanel').classList.remove('hidden');
                document.getElementById('editorPanel').classList.add('hidden');
                document.getElementById('editorPanel').classList.remove('active');
            }
            
            // Деактивируем кнопку редактора в навигации
            const navEditor = document.getElementById('navEditor');
            if (navEditor) {
                navEditor.classList.remove('active');
                navEditor.disabled = true;
            }
            
            // Очищаем поля авторизации
            ['repoOwner', 'repoName', 'githubToken', 'mobileRepoOwner', 'mobileRepoName', 'mobileGithubToken'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            // Очищаем правила
            currentRules = null;
            renderBlocks();
        }
        
        // Обработка изменения пути файла
        function handleFilePathChange(e) {
            const newPath = e.target.value.trim();
            if (newPath && currentRepoInfo) {
                currentRepoInfo.filePath = newPath;
                sessionStorage.setItem('file_path', newPath);
            }
        }
        
        function handleCurrentFilePathChange(e) {
            const newPath = e.target.value.trim();
            if (newPath && currentRepoInfo) {
                currentRepoInfo.filePath = newPath;
                sessionStorage.setItem('file_path', newPath);
                showSnackbar('Путь к файлу изменен', 'info');
            }
        }
        
        // Обработка авторизации
        async function handleLogin() {
            let repoOwner, repoName, token, filePath;
            
            if (isMobile) {
                repoOwner = document.getElementById('mobileRepoOwner').value.trim();
                repoName = document.getElementById('mobileRepoName').value.trim();
                token = document.getElementById('mobileGithubToken').value.trim();
                filePath = DEFAULT_FILE_PATH;
            } else {
                repoOwner = document.getElementById('repoOwner').value.trim();
                repoName = document.getElementById('repoName').value.trim();
                token = document.getElementById('githubToken').value.trim();
                filePath = document.getElementById('filePath').value.trim() || DEFAULT_FILE_PATH;
            }
            
            if (!repoOwner || !repoName || !token) {
                showSnackbar('Заполните все поля', 'error');
                return;
            }
            
            if (!filePath.endsWith('.json')) {
                showSnackbar('Путь должен вести к JSON файлу', 'error');
                return;
            }
            
            showSnackbar('Проверка подключения...', 'info');
            
            try {
                const isValid = await verifyGitHubAccess(token, repoOwner, repoName);
                
                if (isValid) {
                    sessionStorage.setItem('github_token', token);
                    sessionStorage.setItem('repo_owner', repoOwner);
                    sessionStorage.setItem('repo_name', repoName);
                    sessionStorage.setItem('file_path', filePath);
                    
                    currentRepoInfo = { token, repoOwner, repoName, filePath };
                    updateUIForAuthenticated();
                    loadRulesFromRepo();
                    showSnackbar('Подключение успешно', 'success');
                } else {
                    showSnackbar('Неверные данные', 'error');
                }
            } catch (error) {
                showSnackbar('Ошибка подключения', 'error');
                console.error(error);
            }
        }
        
        // Обработка выхода
        function handleLogout() {
            if (confirm('Выйти из системы?')) {
                sessionStorage.clear();
                currentRepoInfo = null;
                currentRules = null;
                updateUIForUnauthenticated();
                showSnackbar('Сессия завершена', 'info');
            }
        }
        
        // Обработка сохранения
        async function handleSave() {
            await saveRulesToRepo();
        }
        
        // Обработка обновления
        async function handleReload() {
            await loadRulesFromRepo();
        }
        
        // Обработка добавления блока
        function handleAddBlock() {
            if (!currentRules) {
                currentRules = { lastUpdate: new Date().toISOString().split('T')[0], blocks: [] };
            }
            
            if (!currentRules.blocks) {
                currentRules.blocks = [];
            }
            
            currentRules.blocks.push({
                id: `block-${Date.now()}`,
                title: 'Новый блок правил',
                icon: 'fas fa-edit',
                items: []
            });
            
            renderBlocks();
            showSnackbar('Блок добавлен', 'success');
        }
        
        // Проверка доступа к GitHub
        async function verifyGitHubAccess(token, owner, repo) {
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                return response.ok;
            } catch {
                return false;
            }
        }
        
        // Загрузка правил
        async function loadRulesFromRepo() {
            if (!currentRepoInfo) return;
            
            showSnackbar('Загрузка...', 'info');
            
            try {
                const { token, repoOwner, repoName, filePath } = currentRepoInfo;
                const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        currentRules = { lastUpdate: new Date().toISOString().split('T')[0], blocks: [] };
                        renderBlocks();
                        showSnackbar('Создан новый файл', 'info');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const binaryString = atob(data.content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decoder = new TextDecoder('utf-8');
                const jsonString = decoder.decode(bytes);
                
                currentRules = jsonString.trim() ? JSON.parse(jsonString) : {
                    lastUpdate: new Date().toISOString().split('T')[0],
                    blocks: []
                };
                
                renderBlocks();
                showSnackbar('Правила загружены', 'success');
            } catch (error) {
                showSnackbar('Ошибка загрузки', 'error');
                console.error(error);
            }
        }
        
        // Сохранение правил
        async function saveRulesToRepo() {
            if (!currentRepoInfo || !currentRules) return;
            
            showSnackbar('Сохранение...', 'info');
            
            try {
                const { token, repoOwner, repoName, filePath } = currentRepoInfo;
                currentRules.lastUpdate = new Date().toISOString().split('T')[0];
                
                // Получаем SHA текущего файла
                const getUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
                const getResponse = await fetch(getUrl, { headers: { 'Authorization': `token ${token}` } });
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // Кодирование
                const jsonString = JSON.stringify(currentRules, null, 2);
                const encoder = new TextEncoder();
                const data = encoder.encode(jsonString);
                let binary = '';
                data.forEach(byte => binary += String.fromCharCode(byte));
                const content = btoa(binary);
                
                // Отправка
                const response = await fetch(getUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Обновление правил через админ-панель',
                        content: content,
                        sha: sha
                    })
                });
                
                if (response.ok) {
                    showSnackbar('Сохранено успешно', 'success');
                } else {
                    throw new Error('Ошибка сохранения');
                }
            } catch (error) {
                showSnackbar('Ошибка сохранения', 'error');
                console.error(error);
            }
        }
        
        // Отображение блоков
        function renderBlocks() {
            const blocksList = isMobile ? document.getElementById('mobileBlocksList') : document.getElementById('blocksList');
            
            if (!currentRules || !currentRules.blocks || currentRules.blocks.length === 0) {
                blocksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Пока нет блоков правил</p>
                        <p class="text-caption">Добавьте первый блок, нажав кнопку ниже</p>
                    </div>
                `;
                return;
            }
            
            blocksList.innerHTML = currentRules.blocks.map((block, blockIndex) => `
                <div class="block-card animate-in">
                    <div class="block-header">
                        <input type="text" class="block-title-input" 
                               value="${escapeHtml(block.title)}" 
                               data-index="${blockIndex}"
                               placeholder="Название блока">
                        <div class="block-actions">
                            ${blockIndex > 0 ? `
                                <button class="icon-button move-up" data-index="${blockIndex}" title="Вверх">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                            ` : ''}
                            ${blockIndex < currentRules.blocks.length - 1 ? `
                                <button class="icon-button move-down" data-index="${blockIndex}" title="Вниз">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                            ` : ''}
                            <button class="icon-button icon-button--danger delete-block" 
                                    data-index="${blockIndex}" 
                                    title="Удалить блок">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="items-list">
                        ${renderItems(block.items, blockIndex)}
                    </div>
                    
                    <button class="button button--tonal add-item" data-index="${blockIndex}" style="margin-top: 12px; width: 100%;">
                        <i class="fas fa-plus"></i>
                        Добавить пункт
                    </button>
                </div>
            `).join('');
            
            attachEventListeners();
        }
        
        // Отображение пунктов
        function renderItems(items, blockIndex) {
            if (!items || items.length === 0) {
                return '<div class="empty-state" style="padding: 12px; font-size: 13px;">Нет пунктов правил</div>';
            }
            
            return items.map((item, itemIndex) => `
                <div class="item-card animate-in" style="animation-delay: ${itemIndex * 0.05}s">
                    <div class="item-header">
                        <span class="item-id">${item.id || `${blockIndex + 1}.${itemIndex + 1}`}</span>
                        <button class="icon-button icon-button--danger delete-item" 
                                data-block="${blockIndex}" 
                                data-index="${itemIndex}"
                                title="Удалить пункт">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <textarea class="item-text" 
                              data-block="${blockIndex}" 
                              data-index="${itemIndex}"
                              placeholder="Текст пункта">${escapeHtml(item.text)}</textarea>
                    
                    <div class="subitems-container">
                        ${renderSubitems(item.subitems, blockIndex, itemIndex)}
                    </div>
                    
                    <button class="button button--outlined add-subitem" 
                            data-block="${blockIndex}" 
                            data-index="${itemIndex}"
                            style="margin-top: 8px; font-size: 12px; width: 100%;">
                        <i class="fas fa-plus"></i>
                        Добавить подпункт
                    </button>
                </div>
            `).join('');
        }
        
        // Отображение подпунктов
        function renderSubitems(subitems, blockIndex, itemIndex) {
            if (!subitems || subitems.length === 0) return '';
            
            return subitems.map((subitem, subIndex) => `
                <div class="subitem-item animate-in" style="animation-delay: ${subIndex * 0.03}s">
                    <i class="fas fa-minus" style="color: var(--md-outline); font-size: 11px; flex-shrink: 0;"></i>
                    <input type="text" class="subitem-input" 
                           value="${escapeHtml(subitem)}"
                           data-block="${blockIndex}"
                           data-item="${itemIndex}"
                           data-index="${subIndex}"
                           placeholder="Текст подпункта">
                    <button class="icon-button delete-subitem" 
                            data-block="${blockIndex}"
                            data-item="${itemIndex}"
                            data-index="${subIndex}"
                            style="width: 32px; height: 32px; flex-shrink: 0;">
                        <i class="fas fa-times" style="font-size: 11px;"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Прикрепление обработчиков событий
        function attachEventListeners() {
            const container = isMobile ? document.getElementById('mobileBlocksList') : document.getElementById('blocksList');
            
            // Заголовки блоков
            container.querySelectorAll('.block-title-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    currentRules.blocks[index].title = e.target.value;
                });
            });
            
            // Перемещение блоков
            container.querySelectorAll('.move-up').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    [currentRules.blocks[index], currentRules.blocks[index - 1]] = 
                    [currentRules.blocks[index - 1], currentRules.blocks[index]];
                    renderBlocks();
                    showSnackbar('Блок перемещен', 'info');
                });
            });
            
            container.querySelectorAll('.move-down').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    [currentRules.blocks[index], currentRules.blocks[index + 1]] = 
                    [currentRules.blocks[index + 1], currentRules.blocks[index]];
                    renderBlocks();
                    showSnackbar('Блок перемещен', 'info');
                });
            });
            
            // Удаление блоков
            container.querySelectorAll('.delete-block').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    if (confirm('Удалить блок?')) {
                        currentRules.blocks.splice(index, 1);
                        renderBlocks();
                        showSnackbar('Блок удален', 'info');
                    }
                });
            });
            
            // Добавление пунктов
            container.querySelectorAll('.add-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.index);
                    if (!currentRules.blocks[blockIndex].items) {
                        currentRules.blocks[blockIndex].items = [];
                    }
                    
                    currentRules.blocks[blockIndex].items.push({
                        id: `${blockIndex + 1}.${currentRules.blocks[blockIndex].items.length + 1}`,
                        text: 'Новый пункт правил',
                        subitems: []
                    });
                    
                    renderBlocks();
                    showSnackbar('Пункт добавлен', 'success');
                });
            });
            
            // Текст пунктов
            container.querySelectorAll('.item-text').forEach(textarea => {
                textarea.addEventListener('input', (e) => {
                    const blockIndex = parseInt(e.target.dataset.block);
                    const itemIndex = parseInt(e.target.dataset.index);
                    currentRules.blocks[blockIndex].items[itemIndex].text = e.target.value;
                });
            });
            
            // Удаление пунктов
            container.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.block);
                    const itemIndex = parseInt(e.target.closest('button').dataset.index);
                    if (confirm('Удалить пункт?')) {
                        currentRules.blocks[blockIndex].items.splice(itemIndex, 1);
                        renderBlocks();
                        showSnackbar('Пункт удален', 'info');
                    }
                });
            });
            
            // Добавление подпунктов
            container.querySelectorAll('.add-subitem').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.block);
                    const itemIndex = parseInt(e.target.closest('button').dataset.index);
                    const item = currentRules.blocks[blockIndex].items[itemIndex];
                    
                    if (!item.subitems) item.subitems = [];
                    item.subitems.push('Новый подпункт');
                    
                    renderBlocks();
                    showSnackbar('Подпункт добавлен', 'success');
                });
            });
            
            // Редактирование подпунктов
            container.querySelectorAll('.subitem-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const blockIndex = parseInt(e.target.dataset.block);
                    const itemIndex = parseInt(e.target.dataset.item);
                    const subIndex = parseInt(e.target.dataset.index);
                    currentRules.blocks[blockIndex].items[itemIndex].subitems[subIndex] = e.target.value;
                });
            });
            
            // Удаление подпунктов
            container.querySelectorAll('.delete-subitem').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const blockIndex = parseInt(e.target.closest('button').dataset.block);
                    const itemIndex = parseInt(e.target.closest('button').dataset.item);
                    const subIndex = parseInt(e.target.closest('button').dataset.index);
                    currentRules.blocks[blockIndex].items[itemIndex].subitems.splice(subIndex, 1);
                    renderBlocks();
                    showSnackbar('Подпункт удален', 'info');
                });
            });
        }
        
        // Вспомогательные функции
        function showSnackbar(message, type = 'info') {
            const snackbar = document.getElementById('snackbar');
            snackbar.textContent = message;
            snackbar.className = `snackbar snackbar--${type}`;
            snackbar.classList.add('show');
            
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
